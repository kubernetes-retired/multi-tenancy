# Kubernetes Multi-tenancy profile S1

__** Note: This document is incomplete and a work in progress. **__

A description of a reference configuration of a Kubernetes cluster to implement an example of "Soft Multi-tenancy".

## Overall functional model summary

1. A **Tenant** is defined as a team of users/ identities that shall have exclusive use of one or more resources of a Kubernetes cluster in parallel with users of other tenants using their own separate and isolated resources within the same cluster. We will interchangeably use the terms \"users\" or \"members\" of a tenant.

2. In profile S1, a Tenant shall exclusively \"own" 1 or more Kubernetes namespaces. In other words, only members of this Tenant are allowed to perform CRUD operations on kubernetes objects in the namespaces owned by this Tenant by default (unless the Tenant is specially configured to allow for broader access and authorization). We shall also use the term \"resources scoped to a Tenant\" to refer to resources that are scoped to namespaces owned by that Tenant.

3. This profile shall support the following persona types.

| Persona | Description |
| ------- | -------|
| *Cluster-admin*     | This persona has full read/write privileges for all resources in the cluster including resources owned by various Tenants of the cluster.|
| *Cluster-view*      | This persona has read privileges for all resources in the cluster including reasources owned by various Tenants. |
| *Tenant-admin*      | This persona has privileges to create a new tenant, read/write resources scoped to that Tenant and update or delete that Tenant. This persona does not have any privileges for accessing resources that are either cluster-scoped or scoped to namespaces that are not associated with the Tenant object for which this persona has Tenant-admin privileges.| 
| *Tenant-user*      | This persona has read/write privileges for all resources scoped within a specific Tenant (that is resources that are scoped within namespaces that are owned by a specific Tenant)  |

## Kubernetes cluster configuration requirements for profile S1

1. The recommended minimum version of Kubernetes release is 1.11. Earlier kubernetes releases may be used with some potential restrictions.  (Note: Maybe better to list api versions required for various Kubernetes resources/ apis).
2. Kubernetes Role Based Access Control RBAC must be supported and enabled.
3. Alternately a functional equivalent of Kubernetes RBAC may be supported via alternative authorization mechanisms such as Open Policy Agent based access control as long as the behavior and requirements listed below are met.
4. Attribute Based Access Control or static file based access control options should be disabled on the cluster.
5. The following set of Kubernetes built-in admission controllers is recommended to be enabled.  Functionally equivalent admission control via alternative mechanisms such as Open Policy Agent or other custom admission controllers may be used as long as they are functionally equivalent to the requirements listed here.
  - PodSecurityPolicy
  - AlwaysPullImages
  - NodeRestriction
  - ServiceAccount
  - ResourceQuota
  - LimitRanger
6. The container networking plugin used in the cluster must support Kubernetes Network policy at version v1beta1 at a minimum.
7. \<This section is incomplete and a work in progress ... needs rework and further updates ... \>


## Feature and Behavioral Requirements of profile S1

1. An explicit Kubernetes resource shall be made available in the cluster to represent a Tenant resource. 
2. A *Tenant-admin* persona shall be able to create a new Tenant resource and explicitly list a set of 1 or more namespaces to be owned by this Tenant. Optionally it should also be possible to have the namespace names be auto-generated by within the cluster without requiring the Tenant-admin persona to explicitly provide namepsace names.
3. Once a Tenant resource and its associated namespaces have been created, it shall be possible for a *Tenant-user* persona to perform CRUD operations on kubernetes objects scoped to namespaces within that tenant.
4. There will be 3 categories of namespaces within a Kubernetes cluster,
  - System namespaces (such as kube-system)
  - Services namespaces (instantiated by a *Cluster-admin* to run services or applications that have network reachability to or from other namsepaces in the cluster as needed to deliver a common service, for instance a shared load balancing service).
  - Tenant namespaces (instantiated by a *Tenant-admin* to run end-user applications and these do not have network reachability to or from other Tenant namespaces by default unless explicitly modified to do so)
5. A cluster supporting this profile must enforce network isolation between tenant namespaces of different tenants using the Network policy listed in Appendix A of this document.
6. A cluster supporting this profile must enforce run time admission control for pods using the policy listed in Appendix B of this document. This policy may be enforced using either standard Kubernetes Pod Security policies or using functionally equivalent alternatives such as custom admission controllers, Open Policy Agent based authorization and admission controllers and so on.
7. Container runtime requirements: This profile may be supported using one of the following combinations of container run-time environments.
  - Docker Community edition version 17.03 or later combined with default Seccomp and SELinux or AppArmor profiles enabled
  - CRI-O version 1.13.0 or later
  - \<work in progress ... to be updated\>


# Appendix A

## Kubernetes CNI Network policy definition for profile S1

\<Work in progress, to be updated this is not the final policy definition\>
```
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  namespace: secondary
  name: deny-from-other-namespaces
spec:
  podSelector:
    matchLabels:
  ingress:
  - from:
    - podSelector: {}
```

# Appendix B

## Kubernetes Pod admission and security policy definition for profile S1

\<Work in progress, this is not the final policy definition. Uses the restricted pod security policy from Kubenetes docs directly for now\>

[Restricted pod policy example](https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/policy/restricted-psp.yaml)

```
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'docker/default'
    apparmor.security.beta.kubernetes.io/allowedProfileNames: 'runtime/default'
    seccomp.security.alpha.kubernetes.io/defaultProfileName:  'docker/default'
    apparmor.security.beta.kubernetes.io/defaultProfileName:  'runtime/default'
spec:
  privileged: false
  # Required to prevent escalations to root.
  allowPrivilegeEscalation: false
  # This is redundant with non-root + disallow privilege escalation,
  # but we can provide it for defense in depth.
  requiredDropCapabilities:
    - ALL
  # Allow core volume types.
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    # Assume that persistentVolumes set up by the cluster admin are safe to use.
    - 'persistentVolumeClaim'
  hostNetwork: false
  hostIPC: false
  hostPID: false
  runAsUser:
    # Require the container to run without root privileges.
    rule: 'MustRunAsNonRoot'
  seLinux:
    # This policy assumes the nodes are using AppArmor rather than SELinux.
    rule: 'RunAsAny'
  supplementalGroups:
    rule: 'MustRunAs'
    ranges:
      # Forbid adding the root group.
      - min: 1
        max: 65535
  fsGroup:
    rule: 'MustRunAs'
    ranges:
      # Forbid adding the root group.
      - min: 1
        max: 65535
  readOnlyRootFilesystem: false

```
